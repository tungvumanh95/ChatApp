<html>
	<head>
		<title>Chat Application	</title>
		<link rel="stylesheet" type="text/css" href="css/style.css">
		<script type="text/javascript" src="/jquery/jquery.js"></script>
		<script type="text/javascript" src="socket.io/socket.io.js"></script>
	</head>
	<body>
		<div id="wrapper">
			<h3>Chat Room</h3>
			<!-- Enter UserName -->
			<div id="loginWrap">
				<p>Enter a user name</p>
				<p id="loginError"></p>
				<form id="loginForm">
					<input size="35" id="userName"/>
					<input type="submit"/>
				</form>
			</div>

			<!-- Message Box-->
			<div id="contentWrap">
				<h2 id ="userNameDisplay"></h2>
				<div id="chatWrap">
					<div id="chat"></div>
					<form id="send-message">
						<input type="text" size="35" id="message"/>
						<input type="submit"/>
					</form>
				</div>
				<div id="users"></div>
			</div>
		</div>

		<script>
			$(document).ready(function(){
				var socket = io.connect();
				var $loginForm = $('#loginForm');
				var $loginError = $('#loginError');
				var $userName = $('#userName');
				var $messageForm = $('#send-message');
				var $messageBox = $('#message');
				var $chat = $('#chat');
				var $users = $('#users');
				// var userName = prompt('Enter your name', 'Anonymous') || 'Anonymous';

				// Login function
				$loginForm.submit(function(e) {
					e.preventDefault();
					var name = $userName.val();
					socket.emit('userLogin', $userName.val(), function(callbackValue) {
						if (callbackValue) {
							$('#loginWrap').hide();
							$('#contentWrap').show();
							$('#userNameDisplay').html(name);
						} else {
							$loginError.html('The userName is invalid or it may be already used. Please Try Again !');
						}
					});
					$userName.val('');
				});

				// Send message function
				$messageForm.submit(function(e){
					// prevent reload the page
					e.preventDefault();
					socket.emit('sendMessageEvent', $messageBox.val());
					$messageBox.val('');
				});

				// listening reciving message event
				socket.on('reciveMessageEvent', function(data){
					$chat.append("<b>" + data.userName + '</b>: ' + data.msg + '<br/>');
				});

				// listening list users
				socket.on('users', function(data){
					var users = '';
					for (var i = 0; i < data.length; i++) {
						users += "<span class='onlineUser'>" + data[i] + '<br/></span>'
					}
					$users.html(users);
				});

				// listening recieve private message
				socket.on('recivePrivateMessageEvent', function(data){
					var toUserName = data.toUserName.trim();
					var msg = data.msg;
					var $messagePrivateFrom = $('#div' + toUserName);
					if ($messagePrivateFrom.length == 0) {
						$('#wrapper').append("<div class='contentWrap'><div id='div" + toUserName + "' class='chatWrap'><div class='chat'></div><form id='" + toUserName + "'  class='send-message'><input type='text'size='35'class='message' name='textBox'/><input type='submit'/></form></div></div>");
						$messagePrivateFrom = $('#div' + toUserName);
					}
					if (data.isSend == true) {
						$messagePrivateFrom.find('.chat').append("<b>" + data.fromUserName.trim() + '</b>: ' + msg + '<br/>');
					} else {
						$messagePrivateFrom.find('.chat').append("<b>" + toUserName + '</b>: ' + msg + '<br/>');
					}
				});

				$(document).on('click', '.onlineUser', function() {
					var userName = this.textContent.trim();
					$('#wrapper').append("<div class='contentWrap'><div id='div" + userName + "' class='chatWrap'><div class='chat'></div><form id='" + userName + "'  class='send-message'><input type='text'size='35'class='message' name='textBox'/><input type='submit'/></form></div></div>");
				});

				$(document).on('submit', '.send-message', function(e) {
					socket.emit('sendPrivateMessage', this.id.trim(), this.elements['textBox'].value);
					this.elements['textBox'].value = '';
					// khong can dung e.preventDefault();
					e.preventDefault()
					return false;
				});
			});
		</script>
	</body>
</html>